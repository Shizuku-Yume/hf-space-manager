<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>HF Space Manager</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --bg-card: #ffffff;
      --bg-hover: #f1f5f9;
      --text-primary: #0f172a;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --border-color: #e2e8f0;
      --accent-color: #3b82f6;
      --accent-hover: #2563eb;
      --success-color: #22c55e;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
    }

    [data-theme="dark"] {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-card: #1e293b;
      --bg-hover: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --border-color: #334155;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.4), 0 2px 4px -2px rgb(0 0 0 / 0.3);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.4), 0 4px 6px -4px rgb(0 0 0 / 0.3);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-secondary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
      transition: background-color 0.3s, color 0.3s;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* Theme Toggle */
    .theme-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 6px;
    }

    .theme-btn {
      background: none;
      border: none;
      padding: 6px 10px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      color: var(--text-secondary);
      font-size: 14px;
      transition: all 0.2s;
    }

    .theme-btn.active {
      background: var(--accent-color);
      color: white;
    }

    .theme-btn:hover:not(.active) {
      background: var(--bg-hover);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .btn-primary {
      background: var(--accent-color);
      color: white;
    }

    .btn-primary:hover {
      background: var(--accent-hover);
    }

    .btn-secondary {
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--bg-hover);
    }

    .btn-danger {
      background: var(--danger-color);
      color: white;
    }

    .btn-danger:hover {
      opacity: 0.9;
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
    }

    .btn-ghost:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-sm);
    }

    .stat-label {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
    }

    /* Filter Panel */
    .filter-panel {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 16px 20px;
      margin-bottom: 24px;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      box-shadow: var(--shadow-sm);
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-group label {
      font-size: 14px;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .filter-group select {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 8px 32px 8px 12px;
      font-size: 14px;
      color: var(--text-primary);
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
    }

    .filter-group select:focus {
      outline: none;
      border-color: var(--accent-color);
    }

    .filter-spacer {
      flex: 1;
    }

    /* Global Keep-Alive Panel */
    .keepalive-panel {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 16px 20px;
      margin-bottom: 24px;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      box-shadow: var(--shadow-sm);
    }

    .keepalive-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .keepalive-title svg {
      width: 18px;
      height: 18px;
      color: var(--success-color);
    }

    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--border-color);
      transition: 0.3s;
      border-radius: 24px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }

    .toggle-switch input:checked + .toggle-slider {
      background-color: var(--success-color);
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(20px);
    }

    /* Number Input */
    .number-input {
      width: 80px;
      padding: 6px 10px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 14px;
      color: var(--text-primary);
      background: var(--bg-secondary);
    }

    .number-input:focus {
      outline: none;
      border-color: var(--accent-color);
    }

    /* User Group */
    .user-group {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      margin-bottom: 16px;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }

    .user-group summary {
      padding: 16px 20px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      list-style: none;
    }

    .user-group summary::-webkit-details-marker {
      display: none;
    }

    .user-group summary::before {
      content: '';
      width: 0;
      height: 0;
      border-left: 5px solid var(--text-secondary);
      border-top: 4px solid transparent;
      border-bottom: 4px solid transparent;
      transition: transform 0.2s;
    }

    .user-group[open] summary::before {
      transform: rotate(90deg);
    }

    .user-group summary:hover {
      background: var(--bg-hover);
    }

    .user-servers {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      padding: 16px;
    }

    /* Instance Card */
    .instance-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 16px;
      transition: all 0.2s;
    }

    .instance-card:hover {
      border-color: var(--accent-color);
      box-shadow: var(--shadow-md);
    }

    .instance-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .instance-name {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      flex: 1;
      min-width: 0;
    }

    .instance-name h3 {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-badge.running {
      background: rgba(34, 197, 94, 0.1);
      color: var(--success-color);
    }

    .status-badge.sleeping {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning-color);
    }

    .status-badge.stopped {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger-color);
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    .status-badge.running .status-dot {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .private-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      background: var(--bg-hover);
      border-radius: 4px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 12px;
    }

    .metric-item {
      background: var(--bg-card);
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-color);
    }

    .metric-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .metric-value {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    /* Info Block */
    .info-block {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: 12px;
      margin-bottom: 12px;
      display: none;
    }

    .instance-card.info-expanded .info-block {
      display: block;
    }

    .info-item {
      margin-bottom: 8px;
    }

    .info-item:last-child {
      margin-bottom: 0;
    }

    .info-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 2px;
    }

    .info-value {
      font-size: 13px;
      color: var(--text-primary);
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    /* Action Buttons */
    .action-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .action-buttons.logged-out {
      display: none;
    }

    /* Schedule Panel */
    .schedule-panel {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: 12px;
      margin-bottom: 12px;
      display: none;
    }

    .instance-card.schedule-expanded .schedule-panel {
      display: block;
    }

    .schedule-section {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .schedule-section:last-child {
      border-bottom: none;
    }

    .schedule-label {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
      min-width: 80px;
    }

    .schedule-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
    }

    .schedule-input {
      width: 70px;
      padding: 6px 8px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      font-size: 13px;
      color: var(--text-primary);
      background: var(--bg-secondary);
    }

    .schedule-unit {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .schedule-status {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Chart Container */
    .chart-container {
      display: none;
      margin-top: 12px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: 12px;
      height: 250px;
    }

    .instance-card.chart-expanded .chart-container {
      display: block;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 24px;
      width: 100%;
      max-width: 400px;
      box-shadow: var(--shadow-lg);
      transform: scale(0.95);
      transition: transform 0.2s;
    }

    .modal-overlay.active .modal {
      transform: scale(1);
    }

    .modal-header {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--text-primary);
    }

    .modal-body {
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 6px;
    }

    .form-group input {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 14px;
      color: var(--text-primary);
      background: var(--bg-secondary);
      transition: border-color 0.2s;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--accent-color);
    }

    .form-error {
      color: var(--danger-color);
      font-size: 13px;
      margin-top: 8px;
    }

    .modal-footer {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
    }

    .loading-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border-color);
      border-top-color: var(--accent-color);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .stats-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 16px;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .user-servers {
        grid-template-columns: 1fr;
      }

      .metrics-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .header {
        flex-direction: column;
        align-items: stretch;
      }

      .header-right {
        justify-content: space-between;
      }

      .filter-panel {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-group {
        width: 100%;
      }

      .filter-group select {
        flex: 1;
      }

      .keepalive-panel {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }
    }

    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .stat-card {
        padding: 14px;
      }

      .stat-value {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <h1 class="logo">HF Space Manager</h1>
      </div>
      <div class="header-right">
        <div class="theme-toggle">
          <button class="theme-btn" data-theme="light" title="浅色模式">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="5"/>
              <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
            </svg>
          </button>
          <button class="theme-btn" data-theme="system" title="跟随系统">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="3" width="20" height="14" rx="2"/>
              <path d="M8 21h8M12 17v4"/>
            </svg>
          </button>
          <button class="theme-btn" data-theme="dark" title="深色模式">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
            </svg>
          </button>
        </div>
        <button class="btn btn-primary" id="loginButton" onclick="showLoginModal()">登录</button>
        <button class="btn btn-secondary" id="logoutButton" style="display: none;" onclick="logout()">登出</button>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">总用户数</div>
        <div class="stat-value" id="totalUsers">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">总实例数</div>
        <div class="stat-value" id="totalServers">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">运行中</div>
        <div class="stat-value" id="onlineServers">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">已停止</div>
        <div class="stat-value" id="offlineServers">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">总上传</div>
        <div class="stat-value" id="totalUpload">0 B/s</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">总下载</div>
        <div class="stat-value" id="totalDownload">0 B/s</div>
      </div>
    </div>

    <!-- Global Keep-Alive Panel -->
    <div class="keepalive-panel" id="keepalivePanel" style="display: none;">
      <div class="keepalive-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
        </svg>
        全局保活设置
      </div>
      <div class="filter-group">
        <label class="toggle-switch">
          <input type="checkbox" id="globalKeepAliveToggle" onchange="toggleGlobalKeepAlive()">
          <span class="toggle-slider"></span>
        </label>
        <span style="font-size: 14px; color: var(--text-secondary);">启用全局保活</span>
      </div>
      <div class="filter-group">
        <label style="font-size: 14px;">间隔时间:</label>
        <input type="number" class="number-input" id="globalKeepAliveInterval" value="30" min="1" max="1440">
        <span style="font-size: 14px; color: var(--text-secondary);">分钟</span>
      </div>
      <button class="btn btn-sm btn-secondary" onclick="saveGlobalKeepAlive()">保存设置</button>
    </div>

    <!-- Filter Panel -->
    <div class="filter-panel">
      <div class="filter-group">
        <label>状态:</label>
        <select id="statusFilter" onchange="applyFiltersAndSort()">
          <option value="all">全部状态</option>
          <option value="running">运行中</option>
          <option value="sleeping">休眠中</option>
          <option value="stopped">已停止</option>
        </select>
      </div>
      <div class="filter-group">
        <label>用户:</label>
        <select id="userFilter" onchange="applyFiltersAndSort()">
          <option value="all">全部用户</option>
        </select>
      </div>
      <div class="filter-group">
        <label>排序:</label>
        <select id="sortBy" onchange="applyFiltersAndSort()">
          <option value="name-asc">名称 (A-Z)</option>
          <option value="name-desc">名称 (Z-A)</option>
          <option value="status-asc">状态 (运行优先)</option>
          <option value="status-desc">状态 (停止优先)</option>
        </select>
      </div>
      <div class="filter-spacer"></div>
      <button class="btn btn-secondary" onclick="refreshData()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M23 4v6h-6M1 20v-6h6"/>
          <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
        </svg>
        刷新
      </button>
    </div>

    <!-- Instances -->
    <div id="servers"></div>
  </div>

  <!-- Login Modal -->
  <div class="modal-overlay" id="loginModal">
    <div class="modal">
      <div class="modal-header">登录</div>
      <div class="modal-body">
        <div class="form-group">
          <label>用户名</label>
          <input type="text" id="username" placeholder="请输入用户名">
        </div>
        <div class="form-group">
          <label>密码</label>
          <input type="password" id="password" placeholder="请输入密码">
        </div>
        <div class="form-error" id="loginError" style="display: none;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideLoginModal()">取消</button>
        <button class="btn btn-primary" onclick="login()">登录</button>
      </div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div class="modal-overlay" id="confirmModal">
    <div class="modal">
      <div class="modal-header" id="confirmTitle">确认操作</div>
      <div class="modal-body">
        <p id="confirmMessage" style="color: var(--text-secondary);"></p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideConfirmModal()">取消</button>
        <button class="btn btn-danger" onclick="confirmAction()">确认</button>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <script>
    // Global state
    let isLoggedIn = false;
    let allInstances = [];
    const instanceMap = new Map();
    const serverStatus = new Map();
    const chartInstances = new Map();
    const chartDataBuffer = new Map();

    // Theme management
    function initTheme() {
      const saved = localStorage.getItem('theme') || 'system';
      applyTheme(saved);
      updateThemeButtons(saved);
    }

    function applyTheme(theme) {
      localStorage.setItem('theme', theme);
      updateThemeButtons(theme);

      if (theme === 'system') {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
      } else {
        document.documentElement.setAttribute('data-theme', theme);
      }
    }

    function updateThemeButtons(activeTheme) {
      document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.theme === activeTheme);
      });
    }

    document.querySelectorAll('.theme-btn').forEach(btn => {
      btn.addEventListener('click', () => applyTheme(btn.dataset.theme));
    });

    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
      if (localStorage.getItem('theme') === 'system') {
        applyTheme('system');
      }
    });

    // Loading state
    function showLoading() {
      document.getElementById('loadingOverlay').classList.add('active');
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('active');
    }

    // Login management
    async function checkLoginStatus() {
      const token = localStorage.getItem('authToken');
      if (token) {
        try {
          showLoading();
          const response = await fetch('/api/verify-token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token })
          });
          const data = await response.json();
          hideLoading();

          if (data.success) {
            isLoggedIn = true;
            updateAuthUI(true);
            return true;
          } else {
            localStorage.removeItem('authToken');
          }
        } catch (error) {
          hideLoading();
          localStorage.removeItem('authToken');
        }
      }
      isLoggedIn = false;
      updateAuthUI(false);
      return false;
    }

    function updateAuthUI(loggedIn) {
      document.getElementById('loginButton').style.display = loggedIn ? 'none' : 'inline-flex';
      document.getElementById('logoutButton').style.display = loggedIn ? 'inline-flex' : 'none';
      document.getElementById('keepalivePanel').style.display = loggedIn ? 'flex' : 'none';

      document.querySelectorAll('.action-buttons').forEach(el => {
        el.classList.toggle('logged-out', !loggedIn);
      });

      document.querySelectorAll('.schedule-toggle').forEach(el => {
        el.style.display = loggedIn ? 'inline-flex' : 'none';
      });
    }

    function showLoginModal() {
      document.getElementById('loginModal').classList.add('active');
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
      document.getElementById('loginError').style.display = 'none';
      document.getElementById('username').focus();
    }

    function hideLoginModal() {
      document.getElementById('loginModal').classList.remove('active');
    }

    async function login() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      try {
        showLoading();
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        const data = await response.json();
        hideLoading();

        if (data.success) {
          localStorage.setItem('authToken', data.token);
          isLoggedIn = true;
          hideLoginModal();
          updateAuthUI(true);
          loadGlobalKeepAliveConfig();
          refreshData();
        } else {
          document.getElementById('loginError').textContent = data.message || '登录失败';
          document.getElementById('loginError').style.display = 'block';
        }
      } catch (error) {
        hideLoading();
        document.getElementById('loginError').textContent = '登录请求失败';
        document.getElementById('loginError').style.display = 'block';
      }
    }

    async function logout() {
      const token = localStorage.getItem('authToken');
      if (token) {
        try {
          await fetch('/api/logout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token })
          });
        } catch (error) {
          console.error('Logout error:', error);
        }
      }
      localStorage.removeItem('authToken');
      isLoggedIn = false;
      updateAuthUI(false);
      refreshData();
    }

    // Confirm modal
    let pendingAction = null;
    let pendingRepoId = null;

    function showConfirmModal(action, repoId, title, message) {
      pendingAction = action;
      pendingRepoId = repoId;
      document.getElementById('confirmTitle').textContent = title;
      document.getElementById('confirmMessage').textContent = message;
      document.getElementById('confirmModal').classList.add('active');
    }

    function hideConfirmModal() {
      document.getElementById('confirmModal').classList.remove('active');
      pendingAction = null;
      pendingRepoId = null;
    }

    async function confirmAction() {
      if (pendingAction === 'restart') {
        await restartSpace(pendingRepoId);
      } else if (pendingAction === 'rebuild') {
        await rebuildSpace(pendingRepoId);
      }
      hideConfirmModal();
    }

    // Global Keep-Alive
    async function loadGlobalKeepAliveConfig() {
      const token = localStorage.getItem('authToken');
      if (!token) return;

      try {
        const response = await fetch('/api/keepalive-global', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        document.getElementById('globalKeepAliveToggle').checked = data.enabled;
        document.getElementById('globalKeepAliveInterval').value = data.intervalMinutes || 30;
      } catch (error) {
        console.error('Failed to load global keep-alive config:', error);
      }
    }

    function toggleGlobalKeepAlive() {
      // Just update UI, actual save happens on button click
    }

    async function saveGlobalKeepAlive() {
      const token = localStorage.getItem('authToken');
      if (!token) return;

      const enabled = document.getElementById('globalKeepAliveToggle').checked;
      const intervalMinutes = parseInt(document.getElementById('globalKeepAliveInterval').value) || 30;

      try {
        showLoading();
        const response = await fetch('/api/keepalive-global', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ enabled, intervalMinutes })
        });
        const data = await response.json();
        hideLoading();

        if (data.success) {
          alert(data.message);
        } else {
          alert('保存失败: ' + (data.error || '未知错误'));
        }
      } catch (error) {
        hideLoading();
        alert('保存失败: ' + error.message);
      }
    }

    // Data fetching
    async function getUsernames() {
      try {
        const response = await fetch('/api/config');
        const config = await response.json();
        const usernames = config.usernames ? config.usernames.split(',').filter(n => n.trim()) : [];
        document.getElementById('totalUsers').textContent = usernames.length;

        const userFilter = document.getElementById('userFilter');
        userFilter.innerHTML = '<option value="all">全部用户</option>';
        usernames.forEach(username => {
          const option = document.createElement('option');
          option.value = username.trim();
          option.textContent = username.trim();
          userFilter.appendChild(option);
        });

        return usernames;
      } catch (error) {
        console.error('Failed to fetch usernames:', error);
        return [];
      }
    }

    async function fetchInstances() {
      const token = localStorage.getItem('authToken');
      const headers = {};
      if (token) headers['Authorization'] = `Bearer ${token}`;

      try {
        showLoading();
        const response = await fetch('/api/proxy/spaces', { headers });
        const instances = await response.json();
        hideLoading();
        return instances;
      } catch (error) {
        hideLoading();
        console.error('Failed to fetch instances:', error);
        return [];
      }
    }

    // Metrics Stream
    class MetricsStreamManager {
      constructor() {
        this.eventSource = null;
      }

      connect(subscribedInstances = []) {
        if (this.eventSource) {
          this.eventSource.close();
        }

        const instancesParam = subscribedInstances.join(',');
        const token = localStorage.getItem('authToken') || '';
        const url = `/api/proxy/live-metrics-stream?instances=${encodeURIComponent(instancesParam)}&token=${encodeURIComponent(token)}`;

        this.eventSource = new EventSource(url);

        this.eventSource.addEventListener('metric', (event) => {
          try {
            const data = JSON.parse(event.data);
            updateServerCard(data.metrics, data.repoId);
          } catch (error) {
            console.error('Failed to parse metrics:', error);
          }
        });

        this.eventSource.onerror = () => {
          this.eventSource.close();
          this.eventSource = null;
          setTimeout(() => this.connect(subscribedInstances), 5000);
        };
      }

      disconnect() {
        if (this.eventSource) {
          this.eventSource.close();
          this.eventSource = null;
        }
      }
    }

    const metricsStreamManager = new MetricsStreamManager();

    // Render functions
    function renderInstances(instances) {
      const container = document.getElementById('servers');
      container.innerHTML = '';

      const userGroups = {};
      instances.forEach(instance => {
        if (!userGroups[instance.owner]) {
          userGroups[instance.owner] = [];
        }
        userGroups[instance.owner].push(instance);
      });

      Object.keys(userGroups).forEach(owner => {
        const group = document.createElement('details');
        group.className = 'user-group';
        group.open = true;

        const summary = document.createElement('summary');
        summary.textContent = owner;
        group.appendChild(summary);

        const serversDiv = document.createElement('div');
        serversDiv.className = 'user-servers';
        group.appendChild(serversDiv);

        container.appendChild(group);

        userGroups[owner].forEach(instance => {
          renderInstanceCard(instance, serversDiv);
        });
      });
    }

    function renderInstanceCard(instance, container) {
      const card = document.createElement('div');
      card.className = 'instance-card';
      card.id = `instance-${instance.repo_id}`;

      instanceMap.set(instance.repo_id, instance);

      const statusClass = instance.status.toLowerCase();
      const statusText = statusClass === 'running' ? '运行中' : statusClass === 'sleeping' ? '休眠中' : '已停止';
      const lastModified = formatRelativeTime(instance.last_modified);

      card.innerHTML = `
        <div class="instance-header">
          <div class="instance-name" onclick="toggleInfo('${instance.repo_id}')">
            <div class="status-badge ${statusClass}">
              <span class="status-dot"></span>
              ${statusText}
            </div>
            <h3 title="${instance.name}">${instance.name}</h3>
            ${instance.private ? '<span class="private-badge">私有</span>' : ''}
          </div>
          <div style="display: flex; gap: 6px;">
            <button class="btn btn-sm btn-ghost schedule-toggle" style="display: ${isLoggedIn ? 'inline-flex' : 'none'};" onclick="toggleSchedule('${instance.repo_id}')" title="定时设置">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 6v6l4 2"/>
              </svg>
            </button>
            <button class="btn btn-sm btn-ghost" onclick="toggleChart('${instance.repo_id}')" title="查看图表">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 3v18h18"/>
                <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/>
              </svg>
            </button>
          </div>
        </div>
        <div class="metrics-grid">
          <div class="metric-item">
            <div class="metric-label">CPU</div>
            <div class="metric-value cpu-usage">N/A</div>
          </div>
          <div class="metric-item">
            <div class="metric-label">内存</div>
            <div class="metric-value memory-usage">N/A</div>
          </div>
          <div class="metric-item">
            <div class="metric-label">上传</div>
            <div class="metric-value upload">N/A</div>
          </div>
          <div class="metric-item">
            <div class="metric-label">下载</div>
            <div class="metric-value download">N/A</div>
          </div>
        </div>
        <div class="info-block">
          <div class="info-item">
            <div class="info-label">描述</div>
            <div class="info-value">${instance.short_description || 'N/A'}</div>
          </div>
          <div class="info-item">
            <div class="info-label">最后更新</div>
            <div class="info-value">${lastModified}</div>
          </div>
        </div>
        <div class="schedule-panel" id="schedule-${instance.repo_id}">
          <div class="schedule-section">
            <span class="schedule-label">定时重启</span>
            <div class="schedule-controls">
              <label class="toggle-switch">
                <input type="checkbox" id="restart-toggle-${instance.repo_id}">
                <span class="toggle-slider"></span>
              </label>
              <span style="font-size: 13px; color: var(--text-secondary);">每</span>
              <input type="number" class="schedule-input" id="restart-interval-${instance.repo_id}" value="24" min="1" max="720">
              <span class="schedule-unit">小时</span>
              <button class="btn btn-sm btn-secondary" onclick="saveScheduledRestart('${instance.repo_id}')">保存</button>
            </div>
          </div>
          <div class="schedule-section">
            <span class="schedule-label">保活 Ping</span>
            <div class="schedule-controls">
              <label class="toggle-switch">
                <input type="checkbox" id="keepalive-toggle-${instance.repo_id}">
                <span class="toggle-slider"></span>
              </label>
              <span style="font-size: 13px; color: var(--text-secondary);">每</span>
              <input type="number" class="schedule-input" id="keepalive-interval-${instance.repo_id}" value="30" min="1" max="1440">
              <span class="schedule-unit">分钟</span>
              <button class="btn btn-sm btn-secondary" onclick="saveKeepAlive('${instance.repo_id}')">保存</button>
            </div>
          </div>
        </div>
        <div class="action-buttons ${isLoggedIn ? '' : 'logged-out'}">
          <button class="btn btn-sm btn-secondary" onclick="viewInstance('${instance.url}')">查看</button>
          <button class="btn btn-sm btn-secondary" onclick="manageInstance('${instance.repo_id}')">管理</button>
          <button class="btn btn-sm btn-secondary" onclick="showConfirmModal('restart', '${instance.repo_id}', '确认重启', '确定要重启实例 ${instance.name} 吗？')">重启</button>
          <button class="btn btn-sm btn-danger" onclick="showConfirmModal('rebuild', '${instance.repo_id}', '确认重建', '确定要重建实例 ${instance.name} 吗？此操作将清除所有数据。')">重建</button>
        </div>
        <div class="chart-container">
          <canvas id="chart-${instance.repo_id}"></canvas>
        </div>
      `;

      container.appendChild(card);

      serverStatus.set(instance.repo_id, {
        lastSeen: Date.now(),
        isOnline: statusClass === 'running',
        isSleep: statusClass === 'sleeping',
        data: null,
        status: instance.status
      });

      // Load schedule configs if logged in
      if (isLoggedIn) {
        loadScheduleConfig(instance.repo_id);
      }
    }

    // Toggle functions
    function toggleInfo(repoId) {
      const card = document.getElementById(`instance-${repoId}`);
      if (card) card.classList.toggle('info-expanded');
    }

    function toggleSchedule(repoId) {
      const card = document.getElementById(`instance-${repoId}`);
      if (card) card.classList.toggle('schedule-expanded');
    }

    function toggleChart(repoId) {
      const card = document.getElementById(`instance-${repoId}`);
      if (card) {
        const wasExpanded = card.classList.contains('chart-expanded');
        card.classList.toggle('chart-expanded');
        if (!wasExpanded && !chartInstances.has(repoId)) {
          createChart(repoId);
        }
      }
    }

    // Schedule management
    async function loadScheduleConfig(repoId) {
      const token = localStorage.getItem('authToken');
      if (!token) return;

      try {
        // Load restart config
        const restartRes = await fetch(`/api/schedule/restart/${encodeURIComponent(repoId)}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const restartData = await restartRes.json();
        const restartToggle = document.getElementById(`restart-toggle-${repoId}`);
        const restartInterval = document.getElementById(`restart-interval-${repoId}`);
        if (restartToggle) restartToggle.checked = restartData.enabled;
        if (restartInterval && restartData.intervalHours) restartInterval.value = restartData.intervalHours;

        // Load keep-alive config
        const keepaliveRes = await fetch(`/api/keepalive/${encodeURIComponent(repoId)}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const keepaliveData = await keepaliveRes.json();
        const keepaliveToggle = document.getElementById(`keepalive-toggle-${repoId}`);
        const keepaliveInterval = document.getElementById(`keepalive-interval-${repoId}`);
        if (keepaliveToggle) keepaliveToggle.checked = keepaliveData.enabled;
        if (keepaliveInterval && keepaliveData.intervalMinutes) keepaliveInterval.value = keepaliveData.intervalMinutes;
      } catch (error) {
        console.error('Failed to load schedule config:', error);
      }
    }

    async function saveScheduledRestart(repoId) {
      const token = localStorage.getItem('authToken');
      if (!token) {
        alert('请先登录');
        return;
      }

      const enabled = document.getElementById(`restart-toggle-${repoId}`).checked;
      const intervalHours = parseInt(document.getElementById(`restart-interval-${repoId}`).value) || 24;

      try {
        showLoading();
        const response = await fetch(`/api/schedule/restart/${encodeURIComponent(repoId)}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ enabled, intervalHours })
        });
        const data = await response.json();
        hideLoading();
        alert(data.success ? data.message : '保存失败: ' + data.error);
      } catch (error) {
        hideLoading();
        alert('保存失败: ' + error.message);
      }
    }

    async function saveKeepAlive(repoId) {
      const token = localStorage.getItem('authToken');
      if (!token) {
        alert('请先登录');
        return;
      }

      const enabled = document.getElementById(`keepalive-toggle-${repoId}`).checked;
      const intervalMinutes = parseInt(document.getElementById(`keepalive-interval-${repoId}`).value) || 30;

      try {
        showLoading();
        const response = await fetch(`/api/keepalive/${encodeURIComponent(repoId)}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ enabled, intervalMinutes })
        });
        const data = await response.json();
        hideLoading();
        alert(data.success ? data.message : '保存失败: ' + data.error);
      } catch (error) {
        hideLoading();
        alert('保存失败: ' + error.message);
      }
    }

    // Chart functions
    function createChart(instanceId) {
      const canvas = document.getElementById(`chart-${instanceId}`);
      if (!canvas) return null;

      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
      const textColor = isDark ? '#94a3b8' : '#64748b';

      const chart = new Chart(canvas.getContext('2d'), {
        type: 'line',
        data: {
          labels: Array(30).fill(''),
          datasets: [
            { label: 'CPU (%)', data: [], borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', tension: 0.4, fill: true },
            { label: '内存 (%)', data: [], borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.1)', tension: 0.4, fill: true },
            { label: '上传 (KB/s)', data: [], borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,0.1)', tension: 0.4, fill: true },
            { label: '下载 (KB/s)', data: [], borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.1)', tension: 0.4, fill: true }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: textColor, font: { size: 11 } } }
          },
          scales: {
            y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor, font: { size: 10 } } },
            x: { grid: { color: gridColor }, ticks: { display: false } }
          },
          elements: { point: { radius: 0 }, line: { borderWidth: 2 } },
          animation: false
        }
      });

      chartInstances.set(instanceId, chart);
      return chart;
    }

    function updateChart(instanceId, data) {
      let buffer = chartDataBuffer.get(instanceId) || { count: 0 };
      buffer.count++;
      if (buffer.count < 2) {
        chartDataBuffer.set(instanceId, buffer);
        return;
      }

      let chart = chartInstances.get(instanceId);
      if (!chart) return;

      const datasets = chart.data.datasets;
      datasets[0].data.push(data.cpu_usage_pct);
      datasets[1].data.push(((data.memory_used_bytes / data.memory_total_bytes) * 100).toFixed(2));
      datasets[2].data.push((data.tx_bps / 1024).toFixed(2));
      datasets[3].data.push((data.rx_bps / 1024).toFixed(2));

      datasets.forEach(ds => { if (ds.data.length > 30) ds.data.shift(); });

      chart.update();
      chartDataBuffer.set(instanceId, { count: 0 });
    }

    // Update functions
    function updateServerCard(data, instanceId) {
      const card = document.getElementById(`instance-${instanceId}`);
      if (!card) return;

      const instance = instanceMap.get(instanceId);

      if (data) {
        card.querySelector('.cpu-usage').textContent = `${data.cpu_usage_pct}%`;
        card.querySelector('.memory-usage').textContent = `${((data.memory_used_bytes / data.memory_total_bytes) * 100).toFixed(1)}%`;
        card.querySelector('.upload').textContent = `${formatBytes(data.tx_bps)}/s`;
        card.querySelector('.download').textContent = `${formatBytes(data.rx_bps)}/s`;

        const badge = card.querySelector('.status-badge');
        badge.className = 'status-badge running';
        badge.innerHTML = '<span class="status-dot"></span>运行中';

        serverStatus.set(instanceId, { lastSeen: Date.now(), isOnline: true, isSleep: false, data, status: 'running' });
        updateChart(instanceId, data);
      }

      updateSummary();
    }

    function updateSummary() {
      let online = 0, offline = 0, totalUpload = 0, totalDownload = 0;

      serverStatus.forEach((status) => {
        if (status.isOnline || status.status.toLowerCase() === 'running') {
          online++;
          if (status.data) {
            totalUpload += status.data.tx_bps || 0;
            totalDownload += status.data.rx_bps || 0;
          }
        } else {
          offline++;
        }
      });

      document.getElementById('totalServers').textContent = serverStatus.size;
      document.getElementById('onlineServers').textContent = online;
      document.getElementById('offlineServers').textContent = offline;
      document.getElementById('totalUpload').textContent = `${formatBytes(totalUpload)}/s`;
      document.getElementById('totalDownload').textContent = `${formatBytes(totalDownload)}/s`;
    }

    // Filter and sort
    function applyFiltersAndSort() {
      const statusFilter = document.getElementById('statusFilter').value;
      const userFilter = document.getElementById('userFilter').value;
      const sortBy = document.getElementById('sortBy').value;

      let filtered = [...allInstances];

      if (statusFilter !== 'all') {
        filtered = filtered.filter(i => i.status.toLowerCase() === statusFilter);
      }
      if (userFilter !== 'all') {
        filtered = filtered.filter(i => i.owner === userFilter);
      }

      filtered.sort((a, b) => {
        const statusOrder = { running: 0, sleeping: 1, stopped: 2 };
        if (sortBy === 'name-asc') return a.name.localeCompare(b.name);
        if (sortBy === 'name-desc') return b.name.localeCompare(a.name);
        if (sortBy === 'status-asc') return (statusOrder[a.status.toLowerCase()] || 2) - (statusOrder[b.status.toLowerCase()] || 2);
        if (sortBy === 'status-desc') return (statusOrder[b.status.toLowerCase()] || 0) - (statusOrder[a.status.toLowerCase()] || 0);
        return 0;
      });

      instanceMap.clear();
      serverStatus.clear();
      chartInstances.forEach(c => c && c.destroy());
      chartInstances.clear();
      chartDataBuffer.clear();

      renderInstances(filtered);

      const runningInstances = filtered.filter(i => i.status.toLowerCase() === 'running').map(i => i.repo_id);
      metricsStreamManager.disconnect();
      metricsStreamManager.connect(runningInstances);

      updateSummary();
    }

    // Actions
    async function restartSpace(repoId) {
      const token = localStorage.getItem('authToken');
      if (!token) {
        alert('请先登录');
        return;
      }

      try {
        showLoading();
        const response = await fetch(`/api/proxy/restart/${encodeURIComponent(repoId)}`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        hideLoading();

        if (data.success) {
          alert('重启成功');
          refreshData();
        } else {
          alert('重启失败: ' + (data.error || '未知错误'));
        }
      } catch (error) {
        hideLoading();
        alert('重启失败: ' + error.message);
      }
    }

    async function rebuildSpace(repoId) {
      const token = localStorage.getItem('authToken');
      if (!token) {
        alert('请先登录');
        return;
      }

      try {
        showLoading();
        const response = await fetch(`/api/proxy/rebuild/${encodeURIComponent(repoId)}`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        hideLoading();

        if (data.success) {
          alert('重建成功');
          refreshData();
        } else {
          alert('重建失败: ' + (data.error || '未知错误'));
        }
      } catch (error) {
        hideLoading();
        alert('重建失败: ' + error.message);
      }
    }

    function viewInstance(url) {
      window.open(url, '_blank');
    }

    function manageInstance(repoId) {
      window.open(`https://huggingface.co/spaces/${repoId}`, '_blank');
    }

    // Utilities
    function formatBytes(bytes) {
      if (!bytes || bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function formatRelativeTime(dateStr) {
      if (!dateStr) return '未知';
      try {
        const date = new Date(dateStr);
        const diff = Date.now() - date.getTime();
        const mins = Math.floor(diff / 60000);
        const hrs = Math.floor(mins / 60);
        const days = Math.floor(hrs / 24);

        if (days > 7) return date.toLocaleDateString();
        if (days > 0) return `${days}天前`;
        if (hrs > 0) return `${hrs}小时前`;
        if (mins > 0) return `${mins}分钟前`;
        return '刚刚';
      } catch {
        return '未知';
      }
    }

    // Initialize
    async function initialize() {
      await getUsernames();
      const instances = await fetchInstances();
      allInstances = instances;
      renderInstances(allInstances);

      const runningInstances = instances.filter(i => i.status.toLowerCase() === 'running').map(i => i.repo_id);
      metricsStreamManager.connect(runningInstances);

      updateSummary();
      updateAuthUI(isLoggedIn);

      if (isLoggedIn) {
        loadGlobalKeepAliveConfig();
      }
    }

    async function refreshData() {
      metricsStreamManager.disconnect();
      chartInstances.forEach(c => c && c.destroy());
      chartInstances.clear();
      chartDataBuffer.clear();
      await initialize();
      applyFiltersAndSort();
    }

    // Entry point
    window.onload = async function() {
      initTheme();
      await checkLoginStatus();
      await initialize();
    };

    // Auto refresh
    setInterval(updateSummary, 5000);
    setInterval(refreshData, 300000);
  </script>
</body>
</html>
